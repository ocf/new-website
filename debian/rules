#!/usr/bin/make -f
BIN := debian/ocfweb/usr/share/python/ocfweb/bin
PYTHON := $(BIN)/python
STATIC_DIR := debian/ocfweb/usr/share/ocfweb/static
ASSET_DIR := debian/ocfweb/usr/share/python/ocfweb/lib/python3.4/site-packages/ocfweb/static

# XXX: We have to unexport LDFLAGS to avoid breaking the numpy build;
# alternatively, we can add `-shared` to LDFLAGS, but then that breaks
# the pycrypto build.
#
# Simply unexporting it is probably closest to what will happen when you
# manually pip install, so should be okay.
unexport LDFLAGS

%:
	dh $@ --with python-virtualenv --with systemd

override_dh_virtualenv:
	# XXX: pip 8.1.0 breaks our build
	# https://github.com/ocf/ocfweb/issues/159
	dh_virtualenv --python=/usr/bin/python3 --preinstall=pip==8.0.3 --preinstall=wheel==0.29.0

	# build sass, output static files
	$(PYTHON) $(BIN)/sassc $(ASSET_DIR)/scss/site.scss $(ASSET_DIR)/scss/site.scss.css
	mkdir -p "$(STATIC_DIR)"
	OCFWEB_STATIC_ROOT="$(STATIC_DIR)" \
		$(PYTHON) manage.py collectstatic --noinput

override_dh_systemd_enable:
	dh_systemd_enable ocfweb.service ocfweb-background.service

override_dh_systemd_start:
	dh_systemd_start ocfweb.service ocfweb-background.service

override_dh_auto_clean:
	# don't want to run `make clean` since it will wipe out the dev venv
	rm -rf *.egg-info

override_dh_auto_build:
	# don't want to run `make`
	@true
